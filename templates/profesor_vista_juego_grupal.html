<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego en Vivo (Grupal) - {{ cuestionario['titulo'] }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .game-header {
            background: white;
            border-radius: 20px;
            padding: 25px 35px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .game-header h1 {
            color: #333;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .game-stats {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .stat-box {
            text-align: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .stat-box .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .timer-box {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
        }

        .timer-box .value {
            color: white;
            font-size: 36px;
        }

        /* Pregunta en pantalla grande */
        .question-display {
            background: white;
            border-radius: 20px;
            padding: 50px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-number {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 42px;
            color: #333;
            margin-bottom: 50px;
            line-height: 1.4;
            font-weight: 600;
        }

        .options-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .option-card {
            padding: 30px;
            border-radius: 20px;
            font-size: 24px;
            text-align: left;
            border: 4px solid #e0e0e0;
            background: #f8f9fa;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .option-letter {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .option-text {
            flex-grow: 1;
            font-weight: 500;
        }

        /* Barra de progreso de tiempo */
        .timer-bar-container {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 30px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .timer-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 1s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        /* Panel de grupos en vivo */
        .grupos-panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .grupos-panel h3 {
            color: #333;
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .grupos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .grupo-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .grupo-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .grupo-item.answered {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .grupo-item.waiting {
            border-left-color: #ffc107;
        }

        .grupo-item .grupo-nombre {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grupo-item .grupo-score {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .grupo-item .miembros {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.answered {
            background: #d4edda;
            color: #155724;
        }

        /* Pantalla de espera inicial */
        .waiting-screen {
            text-align: center;
            padding: 100px 20px;
        }

        .waiting-screen .icon {
            font-size: 120px;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .waiting-screen h2 {
            font-size: 36px;
            color: #333;
            margin-bottom: 20px;
        }

        .waiting-screen p {
            font-size: 18px;
            color: #666;
        }

        /* Pantalla de resultados finales */
        .results-screen {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }

        .results-screen h2 {
            font-size: 42px;
            color: #333;
            margin-bottom: 40px;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 30px;
            margin-bottom: 50px;
        }

        .podium-place {
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .podium-place:hover {
            transform: translateY(-10px);
        }

        .podium-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            order: 2;
            height: 300px;
            width: 250px;
        }

        .podium-2 {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            order: 1;
            height: 240px;
            width: 220px;
        }

        .podium-3 {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            order: 3;
            height: 200px;
            width: 200px;
        }

        .podium-place .medal {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .podium-place .name {
            font-size: 20px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .podium-place .score {
            font-size: 32px;
            font-weight: bold;
            color: white;
        }

        .ranking-table {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            border-collapse: collapse;
        }

        .ranking-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ranking-table thead th {
            padding: 15px;
            color: white;
            font-weight: 600;
            text-align: left;
        }

        .ranking-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .ranking-table tbody td {
            padding: 15px;
            color: #333;
        }

        .ranking-table tbody tr:hover {
            background: #f8f9fa;
        }

        .btn-finish {
            margin-top: 40px;
            padding: 18px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-finish:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 1024px) {
            .options-display {
                grid-template-columns: 1fr;
            }

            .question-text {
                font-size: 32px;
            }

            .podium {
                flex-direction: column;
                align-items: center;
            }

            .podium-place {
                width: 100%;
                max-width: 300px;
                height: auto !important;
            }

            .grupos-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header con estad√≠sticas -->
        <div class="game-header">
            <h1>
                <span>üì∫</span>
                <span>{{ cuestionario['titulo'] }}</span>
                <span style="font-size: 14px; background: #d1ecf1; color: #0c5460; padding: 5px 12px; border-radius: 20px; font-weight: 600;">üë• Grupal</span>
            </h1>

            <div class="game-stats">
                <div class="stat-box">
                    <div class="label">Pregunta</div>
                    <div class="value" id="question-counter">-/-</div>
                </div>

                <div class="stat-box timer-box">
                    <div class="label">Tiempo</div>
                    <div class="value" id="timer-display">--</div>
                </div>

                <div class="stat-box">
                    <div class="label">Grupos</div>
                    <div class="value">{{ total_grupos }}</div>
                </div>
            </div>
        </div>

        <!-- √Årea principal de visualizaci√≥n -->
        <div id="display-area">
            <!-- Pantalla de espera inicial (se oculta cuando inicia) -->
            <div class="question-display" id="waiting-screen">
                <div class="waiting-screen">
                    <div class="icon">üéÆ</div>
                    <h2>¬°El juego est√° por comenzar!</h2>
                    <p>Los grupos est√°n respondiendo...</p>
                </div>
            </div>

            <!-- Pantalla de pregunta (se muestra durante el juego) -->
            <div class="question-display" id="question-screen" style="display: none;">
                <div class="question-number" id="question-number-display">Pregunta 1 de {{ cuestionario['num_preguntas'] }}</div>
                <div class="question-text" id="question-text-display"></div>
                <div class="options-display" id="options-display"></div>
                <div class="timer-bar-container">
                    <div class="timer-bar-fill" id="timer-bar"></div>
                </div>
            </div>

            <!-- Pantalla de resultados finales (se muestra al terminar) -->
            <div class="results-screen" id="results-screen" style="display: none;">
                <h2>üèÜ Resultados Finales</h2>

                <div class="podium" id="podium">
                    <!-- Se llenar√° con JavaScript -->
                </div>

                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Posici√≥n</th>
                            <th>Grupo</th>
                            <th>Puntuaci√≥n</th>
                            <th>Miembros</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- Se llenar√° con JavaScript -->
                    </tbody>
                </table>

                <button class="btn-finish" onclick="volverAlDashboard()">
                    üè† Volver al Dashboard
                </button>
            </div>
        </div>

        <!-- Panel de grupos en tiempo real -->
        <div class="grupos-panel" style="margin-top: 25px;">
            <h3>üë• Grupos en Vivo (<span id="grupos-count">{{ total_grupos }}</span>)</h3>
            <div class="grupos-grid" id="grupos-grid">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>
    </div>

    <script>
    const codigoPin = '{{ cuestionario["codigo_pin"] }}';
    const numPreguntas = {{ cuestionario['num_preguntas'] }};
    const tiempoPorPregunta = {{ cuestionario['tiempo_pregunta'] }};

    let preguntaActual = 0;
    let preguntas = {{ preguntas | tojson }};
    let gruposIds = {{ grupos_ids | tojson }};
    let tiempoRestante = tiempoPorPregunta;
    let timerInterval;
    let pollInterval;
    let gruposData = [];

    console.log('üéÆ Vista Profesor Grupal Iniciada');
    console.log('üìå PIN:', codigoPin);
    console.log('üë• Grupos:', gruposIds);

    function cargarPregunta(index) {
        if (index >= preguntas.length) {
            console.log('üèÅ Todas las preguntas completadas');
            mostrarResultadosFinales();
            return;
        }

        const pregunta = preguntas[index];
        preguntaActual = index;

        console.log(`üìù Cargando pregunta ${index + 1}/${numPreguntas}`);

        document.getElementById('waiting-screen').style.display = 'none';
        document.getElementById('question-screen').style.display = 'block';
        document.getElementById('results-screen').style.display = 'none';

        document.getElementById('question-counter').textContent = `${index + 1}/${numPreguntas}`;
        document.getElementById('question-number-display').textContent = `Pregunta ${index + 1} de ${numPreguntas}`;
        document.getElementById('question-text-display').textContent = pregunta.pregunta;

        const optionsHTML = `
            <div class="option-card">
                <div class="option-letter">A</div>
                <div class="option-text">${pregunta.opcion_a}</div>
            </div>
            <div class="option-card">
                <div class="option-letter">B</div>
                <div class="option-text">${pregunta.opcion_b}</div>
            </div>
            <div class="option-card">
                <div class="option-letter">C</div>
                <div class="option-text">${pregunta.opcion_c}</div>
            </div>
            <div class="option-card">
                <div class="option-letter">D</div>
                <div class="option-text">${pregunta.opcion_d}</div>
            </div>
        `;
        document.getElementById('options-display').innerHTML = optionsHTML;

        iniciarTemporizador();
    }

    function iniciarTemporizador() {
        clearInterval(timerInterval);
        tiempoRestante = tiempoPorPregunta;

        const timerBar = document.getElementById('timer-bar');
        timerBar.style.transition = 'none';
        timerBar.style.width = '100%';

        setTimeout(() => {
            timerBar.style.transition = `width ${tiempoPorPregunta}s linear`;
            timerBar.style.width = '0%';
        }, 50);

        actualizarDisplayTiempo();

        timerInterval = setInterval(() => {
            tiempoRestante--;
            actualizarDisplayTiempo();

            if (tiempoRestante <= 0) {
                clearInterval(timerInterval);
                console.log('‚è∞ Tiempo agotado para pregunta', preguntaActual + 1);

                setTimeout(() => {
                    cargarPregunta(preguntaActual + 1);
                }, 3000);
            }
        }, 1000);
    }

    function actualizarDisplayTiempo() {
        document.getElementById('timer-display').textContent = tiempoRestante + 's';
        document.getElementById('timer-bar').textContent = tiempoRestante + 's';
    }

    function actualizarGrupos() {
        Promise.all(gruposIds.map(grupoId =>
            fetch(`/api/estado_grupo/${grupoId}`)
                .then(response => response.json())
        ))
        .then(datos => {
            gruposData = datos.map((data, index) => ({
                id: gruposIds[index],
                ...data
            }));
            renderizarGrupos();
        })
        .catch(error => {
            console.error('Error al actualizar grupos:', error);
        });
    }

    function renderizarGrupos() {
        const grid = document.getElementById('grupos-grid');

        if (gruposData.length === 0) {
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No hay grupos activos</p>';
            return;
        }

        grid.innerHTML = gruposData.map(grupo => {
            const respondio = grupo.current_question_index > preguntaActual;
            const clase = respondio ? 'answered' : 'waiting';
            const statusText = respondio ? 'Respondi√≥' : 'Esperando...';
            const statusClass = respondio ? 'answered' : 'waiting';

            return `
                <div class="grupo-item ${clase}">
                    <div class="grupo-nombre">
                        <span>${grupo.id ? 'Grupo #' + grupo.id : 'Cargando...'}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="grupo-score">${grupo.current_score || 0} pts</div>
                    <div style="font-size: 12px; color: #666;">
                        Pregunta: ${grupo.current_question_index || 0}/${numPreguntas}
                    </div>
                </div>
            `;
        }).join('');
    }

    function mostrarResultadosFinales() {
        console.log('üèÜ Mostrando resultados finales');
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        document.getElementById('waiting-screen').style.display = 'none';
        document.getElementById('question-screen').style.display = 'none';
        document.getElementById('results-screen').style.display = 'block';

        // Obtener resultados finales de grupos
        Promise.all(gruposIds.map(grupoId =>
            fetch(`/api/estado_grupo/${grupoId}`)
                .then(response => response.json())
        ))
        .then(grupos => {
            const ranking = grupos
                .map((grupo, index) => ({
                    id: gruposIds[index],
                    nombre: `Grupo #${gruposIds[index]}`,
                    puntuacion: grupo.current_score || 0,
                    miembros: grupo.num_miembros || 0
                }))
                .sort((a, b) => b.puntuacion - a.puntuacion);

            renderizarResultados(ranking);
        })
        .catch(error => {
            console.error('Error al cargar ranking:', error);
        });
    }

    function renderizarResultados(ranking) {
        const podium = document.getElementById('podium');
        const top3 = ranking.slice(0, 3);

        const podiumHTML = `
            ${top3[1] ? `
                <div class="podium-place podium-2">
                    <div class="medal">ü•à</div>
                    <div class="name">${top3[1].nombre}</div>
                    <div class="score">${top3[1].puntuacion}</div>
                </div>
            ` : ''}

            ${top3[0] ? `
                <div class="podium-place podium-1">
                    <div class="medal">ü•á</div>
                    <div class="name">${top3[0].nombre}</div>
                    <div class="score">${top3[0].puntuacion}</div>
                </div>
            ` : ''}

            ${top3[2] ? `
                <div class="podium-place podium-3">
                    <div class="medal">ü•â</div>
                    <div class="name">${top3[2].nombre}</div>
                    <div class="score">${top3[2].puntuacion}</div>
                </div>
            ` : ''}
        `;
        podium.innerHTML = podiumHTML;

        const tbody = document.getElementById('ranking-body');
        tbody.innerHTML = ranking.map((grupo, index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1);
            return `
                <tr>
                    <td style="font-weight: bold; font-size: 20px;">${medal}</td>
                    <td>${grupo.nombre}</td>
                    <td style="font-weight: bold; color: #667eea;">${grupo.puntuacion}</td>
                    <td>${grupo.miembros}</td>
                </tr>
            `;
        }).join('');
    }

    function volverAlDashboard() {
        window.location.href = '/dashboard_profesor';
    }

    window.onload = function() {
        console.log('‚úÖ Inicializando vista del profesor (grupal)');

        setTimeout(() => {
            cargarPregunta(0);
        }, 2000);

        pollInterval = setInterval(actualizarGrupos, 2000);
        actualizarGrupos();
    };

    window.addEventListener('beforeunload', function() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);
    });
</script>
</body>
</html>