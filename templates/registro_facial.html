<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Facial</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* [Estilos CSS: Mantener el CSS anterior para la apariencia] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .header p { color: #666; font-size: 16px; }
        .camera-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto 30px; border-radius: 15px; overflow: hidden; background: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        #video { width: 100%; display: block; border-radius: 15px; transform: scaleX(-1); }
        #canvas { display: none; }
        .face-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 3px dashed rgba(102, 126, 234, 0.8); border-radius: 50%; pointer-events: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); } }
        .instructions { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #667eea; }
        .instructions h3 { color: #333; font-size: 18px; margin-bottom: 10px; }
        .instructions ul { list-style: none; padding: 0; }
        .instructions li { color: #666; padding: 8px 0; padding-left: 25px; position: relative; }
        .instructions li::before { content: "‚úì"; position: absolute; left: 0; color: #667eea; font-weight: bold; }
        .button-group { display: flex; gap: 15px; margin-top: 25px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .status-message { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; text-align: center; font-weight: 600; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-message.show { display: block; }
        .status-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .back-link { display: block; text-align: center; color: #667eea; text-decoration: none; margin-top: 20px; font-weight: 600; }
        .back-link:hover { text-decoration: underline; }
        .preview-container { display: none; text-align: center; margin-top: 20px; }
        .preview-container.show { display: block; }
        .preview-image { max-width: 200px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); margin-bottom: 15px; }
        @media (max-width: 600px) { .container { padding: 25px; } .header h1 { font-size: 24px; } .button-group { flex-direction: column; } .face-overlay { width: 150px; height: 150px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ Registro Facial</h1>
            <p>Configura el reconocimiento facial para tu cuenta</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="instructions">
            <h3>üìã Instrucciones:</h3>
            <ul>
                <li>Posiciona tu rostro dentro del c√≠rculo</li>
                <li>Aseg√∫rate de tener buena iluminaci√≥n</li>
                <li>Mira directamente a la c√°mara</li>
                <li>Mant√©n una expresi√≥n neutral</li>
            </ul>
        </div>

        <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay playsinline></video>
            <div class="face-overlay"></div>
        </div>

        <canvas id="canvas"></canvas>

        <div class="preview-container" id="previewContainer">
            <h4>Vista previa capturada:</h4>
            <img id="previewImage" class="preview-image" alt="Preview">
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Procesando tu rostro...</p>
        </div>

        <div class="button-group">
            <button id="btnIniciarCamara" class="btn btn-primary" onclick="iniciarCamara()">
                üì∑ Iniciar C√°mara
            </button>
            <button id="btnCapturar" class="btn btn-primary" onclick="capturarRostro()" disabled>
                ‚úÖ Capturar Rostro
            </button>
            <button class="btn btn-secondary" onclick="volver()">
                ‚Üê Volver
            </button>
        </div>

        <a href="#" class="back-link" onclick="volver(); return false;">Volver al Dashboard</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const btnIniciarCamara = document.getElementById('btnIniciarCamara');
        const btnCapturar = document.getElementById('btnCapturar');
        const statusMessage = document.getElementById('statusMessage');
        const loading = document.getElementById('loading');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        
        let stream = null;
        let modelsLoaded = false; // Usamos esto para controlar la carga
        
        const rol = '{{ rol }}';
        
        // Cargar Modelos de Face-API
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';

        function mostrarMensaje(mensaje, tipo) {
            statusMessage.textContent = mensaje;
            statusMessage.className = 'status-message show ' + tipo;
            
            if (tipo === 'success' || tipo === 'error' || tipo === 'info') {
                 // Mantener el mensaje de √©xito/error visible por un momento
                setTimeout(() => {
                    statusMessage.classList.remove('show');
                }, 5000);
            }
        }

        async function cargarModelos() {
            try {
                console.log('üîÑ Cargando modelos de reconocimiento...');
                mostrarMensaje('‚è≥ Cargando modelos de reconocimiento...', 'info');
                
                await Promise.all([
                    // Cargamos los modelos necesarios para detectar y generar el descriptor
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                
                modelsLoaded = true;
                console.log('‚úÖ Modelos cargados exitosamente');
                mostrarMensaje('‚úÖ Sistema de reconocimiento listo.', 'success');
                return true;
            } catch (error) {
                console.error('‚ùå Error al cargar modelos:', error);
                mostrarMensaje('‚ùå Error al cargar el sistema. Revisa la consola.', 'error');
                return false;
            }
        }
        
        // Iniciar c√°mara
        async function iniciarCamara() {
            try {
                if (!modelsLoaded) {
                    await cargarModelos();
                }

                mostrarMensaje('üì∑ Iniciando c√°mara...', 'info');

                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                await video.play();
                
                btnIniciarCamara.disabled = true;
                btnCapturar.disabled = false;
                mostrarMensaje('‚úÖ C√°mara activa. Posiciona tu rostro y captura.', 'success');

                // Asegurar que el tama√±o del video se refleje en el canvas
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

            } catch (error) {
                console.error('‚ùå Error al iniciar c√°mara:', error);
                mostrarMensaje('‚ùå No se pudo acceder a la c√°mara. Verifica los permisos.', 'error');
                btnIniciarCamara.disabled = false;
            }
        }

        // Capturar rostro, detectar y generar embedding
        async function capturarRostro() {
            if (!stream || !modelsLoaded) {
                mostrarMensaje('‚ö†Ô∏è Primero inicia la c√°mara y espera a que los modelos carguen.', 'error');
                return;
            }
            
            try {
                mostrarMensaje('üîç Detectando rostro y generando c√≥digo...', 'info');
                loading.classList.add('show');
                btnCapturar.disabled = true;
                
                const displaySize = { width: video.videoWidth, height: video.videoHeight };

                // 1. Detecci√≥n y generaci√≥n del Descriptor (Embedding)
                const detection = await faceapi
                    .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                if (!detection) {
                    loading.classList.remove('show');
                    mostrarMensaje('‚ùå No se detect√≥ ning√∫n rostro. Int√©ntalo de nuevo.', 'error');
                    btnCapturar.disabled = false;
                    return;
                }
                
                // 2. Obtener el Embedding
                const embedding = Array.from(detection.descriptor);
                
                // 3. Obtener la imagen capturada para el preview
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Dibujar con efecto espejo para que el preview sea natural
                ctx.save();
                ctx.scale(-1, 1);
                ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
                ctx.restore();
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                
                // Mostrar preview
                previewImage.src = imageDataUrl;
                previewContainer.classList.add('show');
                
                console.log('‚úÖ Rostro detectado, embedding generado:', embedding.length, 'dimensiones');

                // 4. Enviar al backend
                await guardarRostro(embedding);

            } catch (error) {
                loading.classList.remove('show');
                btnCapturar.disabled = false;
                console.error('‚ùå Error al capturar rostro:', error);
                mostrarMensaje('‚ùå Error al procesar: ' + error.message, 'error');
            }
        }

        // Guardar rostro en el backend
        async function guardarRostro(embedding) {
            try {
                mostrarMensaje('üíæ Guardando tu registro facial...', 'info');

                const response = await fetch('/guardar_embedding_facial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        embedding: embedding,
                        // Ya no se env√≠a la imagen, solo el embedding para ahorrar ancho de banda
                    })
                });

                const data = await response.json();
                loading.classList.remove('show');

                if (data.success) {
                    mostrarMensaje('‚úÖ ' + data.message, 'success');
                    
                    // Detener la c√°mara
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }

                    // Redirigir despu√©s de 2 segundos
                    setTimeout(() => {
                        volver();
                    }, 2000);
                } else {
                    mostrarMensaje('‚ùå Error: ' + data.message, 'error');
                    btnCapturar.disabled = false;
                }

            } catch (error) {
                loading.classList.remove('show');
                console.error('‚ùå Error al guardar:', error);
                mostrarMensaje('‚ùå Error al guardar: ' + error.message, 'error');
                btnCapturar.disabled = false;
            }
        }

        // Volver al dashboard
        function volver() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            if (rol === 'profesor') {
                window.location.href = '/dashboard_profesor';
            } else {
                window.location.href = '/dashboard_estudiante';
            }
        }

        // Inicializar la carga del modelo al cargar la p√°gina
        window.addEventListener('load', cargarModelos);

        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>